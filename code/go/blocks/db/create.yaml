version: 3
language: go
name: go-blocks-db-create
type: block
short: Entity body for getting one and only one item from database. Must be inside func and expects a db obj
key: model
model: entity
body: |  
  {{$item_name := .Name | camel | singular}}
  //ctx := context.Background()

  query := `{{ template "sql-insert" . -}}`

  stmt, err := cn.PrepareContext(ctx, query)

  if err != nil {
    return -1, err
  }

  defer stmt.Close()

  {{- range .Columns }} {{ if .IsNullable }}
    var {{ .Name | camel }} *{{ .DataType | datatype }} = nil
    if {{ $item_name }}.{{ .Name | pascal }}.Valid {
        {{ .Name | camel }} = &{{ $item_name }}.{{ .Name | pascal }}.{{ .DataType | datatype | title }}
      }
    {{ end }}{{- end }}

    result, err := stmt.Exec(query,
    {{- range .Columns }}
      {{ if .IsNullable -}}sql.Named("{{ .Name | pascal }}", {{ .Name | camel }}),      
      {{- else }}sql.Named("{{ .Name | pascal }}", {{ $item_name }}.{{ .Name | pascal }}),      
      {{- end -}}
      {{- end }}
    )

    id, err := result.LastInsertId()

    if err != nil {
      return -1, err
    }

  return id, nil